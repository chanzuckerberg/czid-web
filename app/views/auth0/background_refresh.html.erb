<!DOCTYPE html>
<html>
  <pre><%=@refresh_values.to_yaml%></pre>
  <% if @refresh_values[:active] %>
    <script language="javascript">(function () {
      var rv = <%=raw @refresh_values.to_json%>;
      var reload_wait_ms = rv.reload_wait_seconds * 1000;
      if (rv.should_refresh) {
        var now = new Date().getTime();
        var last = localStorage.getItem("background_refresh_last") || 0;
        var elapsed = Math.abs(now - last);
        if (elapsed > 30000) {
          /* <%# Avoid simultaneous calls if multiple tabs are open %> */
          localStorage.setItem("background_refresh_last", now);
          location.href = rv.refresh_endpoint;
          return;
        }
      }
      setTimeout(function () { location.reload(true) }, reload_wait_ms);
    })();</script>
  <% end %>
</html>