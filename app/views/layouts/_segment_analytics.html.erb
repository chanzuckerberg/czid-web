  <!-- Global site tags for Segment analytics-->

<% if ENV["SEGMENT_JS_ID"] %>
  <!-- The script type and class properties are added here so it can give OneTrust the ability to: -->
  <!-- 1. Modify the type "text/javascript" which enables the Segment script (Enabling analytics) -->
  <!-- 2. Modify the type "text/plain" which disables the Segment script (Disabling analytics)-->

  <script type="text/plain" class="optanon-category-C0002">
    // Snippet from https://segment.com/docs/sources/website/analytics.js/quickstart/
    // Segment ID is designed to be public: https://community.segment.com/t/m26sng/writekey-accessible-by-anyone
   !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"];analytics.factory=function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e);analytics.push(t);return analytics}};for(var e=0;e<analytics.methods.length;e++){var key=analytics.methods[e];analytics[key]=analytics.factory(key)}analytics.load=function(key,e){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);analytics._loadOptions=e};analytics.SNIPPET_VERSION="4.13.1";

        // Destination middleware - filter PII from events going to Appcues destination
        // See https://segment.com/docs/connections/sources/catalog/libraries/website/javascript/middleware/ for more information on middleware
        const DMW = ({ payload, integration, next }) => {
          <% if current_user.present? %>
            if (payload.obj.traits){
              payload.obj.traits = <%= raw escape_json(current_user.traits_for_segment(include_pii: false)) %>;
            }
          <% end %>
          next(payload);
        };

        analytics.addDestinationMiddleware('Appcues', [DMW]);
        analytics.load("<%= ENV["SEGMENT_JS_ID"] %>");
        window.GIT_VERSION = "<%= ENV["GIT_VERSION"] %>";
        analytics.page();
    }}();
  </script>
<% end %>
