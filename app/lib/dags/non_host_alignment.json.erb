{
  "output_dir_s3": "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/results",
  "targets": {
    "host_filter_out": [
      "gsnap_filter_1.fa"
      <% if @attribute_dict[:input_file_count] > 1 %>
        , "gsnap_filter_2.fa"
        , "gsnap_filter_merged.fa"
      <% end %>
    ],
    "gsnap_out": [
      "<%= @attribute_dict[:gsnap_m8] %>",
      "gsnap.deduped.m8",
      "gsnap.hitsummary.tab",
      "gsnap_counts.json",
      "gsnap.human.txt"
    ],
    "rapsearch2_out": [
      "<%= @attribute_dict[:rapsearch_m8] %>",
      "rapsearch2.deduped.m8",
      "rapsearch2.hitsummary.tab",
      "rapsearch2_counts.json",
      "rapsearch2.human.txt"
    ],
    "taxon_count_out": ["taxon_counts.json"],
    "annotated_out": ["annotated_merged.fa", "unidentified.fa"]
  },
  "steps": [
    {
      "in": ["host_filter_out"],
      "out": "gsnap_out",
      "class": "PipelineStepRunAlignmentRemotely",
      "module": "idseq_dag.steps.run_alignment_remotely",
      "additional_files": {
        "lineage_db": "<%= @attribute_dict[:lineage_db] %>",
        "accession2taxid_db": "<%= @attribute_dict[:accession2taxid_db] %>"
        <% if @attribute_dict[:skip_dedeuterostome_filter] == 0 %>
          ,"deuterostome_db": "<%= @attribute_dict[:deuterostome_db] %>"
        <% end %>
      },
      "additional_attributes": {
        "service": "gsnap",
        "chunks_in_flight": <%= @attribute_dict[:chunks_in_flight] %>,
        "chunk_size": <%= @attribute_dict[:gsnap_chunk_size] %>,
        "max_concurrent": <%= @attribute_dict[:gsnap_max_concurrent] %>,
        "environment": "<%= Rails.env == 'prod' ? 'prod' : 'staging' %>",
        "max_interval_between_describe_instances": <%= @attribute_dict[:max_interval_between_describe_instances] %>,
        "job_tag_prefix": "<%= @attribute_dict[:job_tag_prefix] %>",
        "job_tag_refresh_seconds": <%= @attribute_dict[:job_tag_refresh_seconds] %>,
        "draining_tag": "<%= @attribute_dict[:draining_tag] %>"
        <% if @attribute_dict[:index_dir_suffix] %>
          ,"index_dir_suffix": "<%= @attribute_dict[:index_dir_suffix] %>"
        <% end %>
      }
    },
    {
      "in": ["host_filter_out"],
      "out": "rapsearch2_out",
      "class": "PipelineStepRunAlignmentRemotely",
      "module": "idseq_dag.steps.run_alignment_remotely",
      "additional_files": {
        "lineage_db": "<%= @attribute_dict[:lineage_db] %>",
        "accession2taxid_db": "<%= @attribute_dict[:accession2taxid_db] %>"
        <% if @attribute_dict[:skip_dedeuterostome_filter] == 0 %>
          ,"deuterostome_db": "<%= @attribute_dict[:deuterostome_db] %>"
        <% end %>
      },
      "additional_attributes": {
        "service": "rapsearch2",
        "chunks_in_flight": <%= @attribute_dict[:chunks_in_flight] %>,
        "chunk_size": <%= @attribute_dict[:rapsearch_chunk_size] %>,
        "max_concurrent": <%= @attribute_dict[:rapsearch_max_concurrent] %>,
        "environment": "<%= Rails.env == 'prod' ? 'prod' : 'staging' %>",
        "max_interval_between_describe_instances": <%= @attribute_dict[:max_interval_between_describe_instances] %>,
        "job_tag_prefix": "<%= @attribute_dict[:job_tag_prefix] %>",
        "job_tag_refresh_seconds": <%= @attribute_dict[:job_tag_refresh_seconds] %>,
        "draining_tag": "<%= @attribute_dict[:draining_tag] %>"
        <% if @attribute_dict[:index_dir_suffix] %>
          ,"index_dir_suffix": "<%= @attribute_dict[:index_dir_suffix] %>"
        <% end %>
      }
    },
    {
      "in": ["gsnap_out", "rapsearch2_out"],
      "out": "taxon_count_out",
      "class": "PipelineStepCombineTaxonCounts",
      "module": "idseq_dag.steps.combine_taxon_counts",
      "additional_files": {},
      "additional_attributes": {}
    },
    {
      "in": ["host_filter_out", "gsnap_out", "rapsearch2_out"],
      "out": "annotated_out",
      "class": "PipelineStepGenerateAnnotatedFasta",
      "module": "idseq_dag.steps.generate_annotated_fasta",
      "additional_files": {},
      "additional_attributes": {}
    }
  ],
  "given_targets": {
    "host_filter_out": {
      "s3_dir": "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/results/<%= @attribute_dict[:pipeline_version] %>"
    }
  }
}
