{
  "output_dir_s3":
    "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/results",
  "targets": {
    "fastqs": [
      "<%= @attribute_dict[:fastq1] %>"
      <% if @attribute_dict[:fastq2] %>
        , "<%= @attribute_dict[:fastq2] %>"
      <% end %>
    ],
    "validate_input_out": [
      "validate_input_summary.json",
      "valid_input1.<%= @attribute_dict[:file_ext] %>"
      <% if @attribute_dict[:fastq2] %>
        , "valid_input2.<%= @attribute_dict[:file_ext] %>"
      <% end %>
      ],
    "star_out": [
      "unmapped1.<%= @attribute_dict[:file_ext] %>"
      <% if @attribute_dict[:fastq2] %>
        , "unmapped2.<%= @attribute_dict[:file_ext] %>"
      <% end %>
    ],
    "trimmomatic_out": [
      "trimmomatic1.<%= @attribute_dict[:file_ext] %>"
      <% if @attribute_dict[:fastq2] %>
        , "trimmomatic2.<%= @attribute_dict[:file_ext] %>"
      <% end %>
    ],
    "priceseq_out": [
      "priceseq1.fa"
      <% if @attribute_dict[:fastq2] %>
        , "priceseq2.fa"
      <% end %>
    ],
    "cdhitdup_out": [
      "dedup1.fa"
      <% if @attribute_dict[:fastq2] %>
        , "dedup2.fa"
      <% end %>
    ],
    "lzw_out": [
      "lzw1.fa"
      <% if @attribute_dict[:fastq2] %>
        , "lzw2.fa"
      <% end %>
    ],
    "bowtie2_out": [
      "bowtie2_1.fa"
      <% if @attribute_dict[:fastq2] %>
        , "bowtie2_2.fa", "bowtie2_merged.fa"
      <% end %>
    ],
    "subsampled_out": [
      "subsampled_1.fa"
      <% if @attribute_dict[:fastq2] %>
        , "subsampled_2.fa", "subsampled_merged.fa"
      <% end %>
    ],
    <% if @host_genome != "human" %>
      "star_human_out": [
        "unmapped_human_1.fa"
        <% if @attribute_dict[:fastq2] %>
          , "unmapped_human_2.fa"
        <% end %>
      ],
      "bowtie2_human_out": [
        "bowtie2_human_1.fa"
        <% if @attribute_dict[:fastq2] %>
          , "bowtie2_human_2.fa", "bowtie2_human_merged.fa"
        <% end %>
      ],
    <% end %>
    "gsnap_filter_out": [
      "gsnap_filter_1.fa"
      <% if @attribute_dict[:fastq2] %>
        , "gsnap_filter_2.fa", "gsnap_filter_merged.fa"
      <% end %>
    ]
  },
  "steps": [
    {
      "in": ["fastqs"],
      "out": "validate_input_out",
      "class": "PipelineStepRunValidateInput",
      "module": "idseq_dag.steps.run_validate_input",
      "additional_files": {},
      "additional_attributes": { "truncate_fragments_to": <%= @attribute_dict[:max_fragments] %>,
                                 "file_ext": "<%= @attribute_dict[:file_ext] %>"}
    },
    {
      "in": ["validate_input_out"],
      "out": "star_out",
      "class": "PipelineStepRunStar",
      "module": "idseq_dag.steps.run_star",
      "additional_files": { "star_genome": "<%= @attribute_dict[:star_genome] %>" },
      "additional_attributes": { "output_gene_file": "reads_per_gene.star.tab" }
    },
    {
      "in": ["star_out"],
      "out": "trimmomatic_out",
      "class": "PipelineStepRunTrimmomatic",
      "module": "idseq_dag.steps.run_trimmomatic",
      "additional_files": {
        "adapter_fasta": "<%= @attribute_dict[:adapter_fasta] %>"
      },
      "additional_attributes": {}
    },
    {
      "in": [
          "trimmomatic_out"
      ],
      "out": "priceseq_out",
      "class": "PipelineStepRunPriceSeq",
      "module": "idseq_dag.steps.run_priceseq",
      "additional_files": {},
      "additional_attributes": {}
    },
    {
      "in": ["priceseq_out"],
      "out": "cdhitdup_out",
      "class": "PipelineStepRunCDHitDup",
      "module": "idseq_dag.steps.run_cdhitdup",
      "additional_files": {},
      "additional_attributes": {}
    },
    {
      "in": ["cdhitdup_out"],
      "out": "lzw_out",
      "class": "PipelineStepRunLZW",
      "module": "idseq_dag.steps.run_lzw",
      "additional_files": {},
      "additional_attributes": {
        "thresholds": [0.45, 0.42],
        "threshold_readlength": 150
      }
    },
    {
      "in": ["lzw_out"],
      "out": "bowtie2_out",
      "class": "PipelineStepRunBowtie2",
      "module": "idseq_dag.steps.run_bowtie2",
      "additional_files": {
        "bowtie2_genome": "<%= @attribute_dict[:bowtie2_genome] %>"
      },
      "additional_attributes": { "output_sam_file": "bowtie2.sam" }
    }
    ,
    {
      "in": ["bowtie2_out"],
      "out": "subsampled_out",
      "class": "PipelineStepRunSubsample",
      "module": "idseq_dag.steps.run_subsample",
      "additional_files": {},
      "additional_attributes": { "max_fragments": <%= @attribute_dict[:max_subsample_frag] %> }
    },
    <% if @host_genome != "human" %>
    { 
      "in": ["subsampled_out", "validate_input_out"],
      "out": "star_human_out",
      "class": "PipelineStepRunStarDownstream",
      "module": "idseq_dag.steps.run_star_downstream",
      "additional_files": { "star_genome": "<%= @attribute_dict[:human_star_genome] %>" },
      "additional_attributes": {}
    },
    { 
      "in": ["star_human_out"],
      "out": "bowtie2_human_out",
      "class": "PipelineStepRunBowtie2",
      "module": "idseq_dag.steps.run_bowtie2",
      "additional_files": { "bowtie2_genome": "<%= @attribute_dict[:human_bowtie2_genome] %>" },
      "additional_attributes": { "output_sam_file": "bowtie2_human.sam" }
    },
    <% end %>
    {
      "in": [
        <% if @host_genome != "human" %>
          "bowtie2_human_out"
        <% else %>
          "subsampled_out"
        <% end %>
      ],
      "out": "gsnap_filter_out",
      "class": "PipelineStepRunGsnapFilter",
      "module": "idseq_dag.steps.run_gsnap_filter",
      "additional_files": {
        "gsnap_genome": "s3://idseq-database/host_filter/human/2018-02-15-utc-1518652800-unixtime__2018-02-15-utc-1518652800-unixtime/hg38_pantro5_k16.tar"
      },
      "additional_attributes": { "output_sam_file": "gsnap_filter.sam" }
    }
  ],
  "given_targets": {
    "fastqs": {
      "s3_dir": "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/fastqs",
      "count_reads": 1,
      "max_fragments": <%= @attribute_dict[:max_fragments] %>
    }
  }
}
