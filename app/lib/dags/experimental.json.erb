{
  "name": "<%= PipelineRunStage::DAG_NAME_EXPERIMENTAL %>",
  "output_dir_s3":
    "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/postprocess",
  "targets": {
    "taxid_fasta_in": [
      "annotated_merged.fa",
      "gsnap.hitsummary.tab",
      "rapsearch2.hitsummary.tab"
    ],
    "refined_gsnap_in": [
      "gsnap.reassigned.m8",
      "gsnap.hitsummary2.tab",
      "gsnap.blast.top.m8"
    ],
    "contig_in": [
      "contig_coverage.json",
      "contig_stats.json",
      "contigs.fasta"
    ],
    "gsnap_m8": ["gsnap.deduped.m8"],
    "taxid_fasta_out": ["taxid_annot.fasta"],
    "taxid_locator_out": [
      "taxid_annot_sorted_nt.fasta",
      "taxid_locations_nt.json",
      "taxid_annot_sorted_nr.fasta",
      "taxid_locations_nr.json",
      "taxid_annot_sorted_genus_nt.fasta",
      "taxid_locations_genus_nt.json",
      "taxid_annot_sorted_genus_nr.fasta",
      "taxid_locations_genus_nr.json",
      "taxid_annot_sorted_family_nt.fasta",
      "taxid_locations_family_nt.json",
      "taxid_annot_sorted_family_nr.fasta",
      "taxid_locations_family_nr.json",
      "taxid_locations_combined.json"
    ],
    "alignment_viz_out": ["align_viz.summary"],
    "srst2_out": ["out.log", "out__genes__ARGannot_r2__results.txt", "out__fullgenes__ARGannot_r2__results.txt", "amr_processed_results.csv", "amr_summary_results.csv", "output__.ARGannot_r2.sorted.bam"],
    "coverage_viz_out": ["coverage_viz_summary.json"],
    <% if @attribute_dict[:fastq2] %>
      "fastqs": ["<%= @attribute_dict[:fastq1] %>", "<%= @attribute_dict[:fastq2] %>"],
    <% else %>
      "fastqs": ["<%= @attribute_dict[:fastq1] %>"],
    <% end %>
    "nonhost_fasta": ["refined_taxid_annot.fasta"],
    <% if @attribute_dict[:file_ext] == "fastq" %>
      <% if @attribute_dict[:fastq2] %>
        "nonhost_fastq_out": ["nonhost_R1.fastq", "nonhost_R2.fastq"]
      <% else %>
        "nonhost_fastq_out": ["nonhost_R1.fastq"]
      <% end %>
    <% else %>
      <% if @attribute_dict[:fastq2] %>
        "nonhost_fastq_out": ["nonhost_R1.fasta", "nonhost_R2.fasta"]
      <% else %>
        "nonhost_fastq_out": ["nonhost_R1.fasta"]
      <% end %>
    <% end %>
  },
  "steps": [
    {
      "in": ["taxid_fasta_in"],
      "out": "taxid_fasta_out",
      "class": "PipelineStepGenerateTaxidFasta",
      "module": "idseq_dag.steps.generate_taxid_fasta",
      "additional_files": {
        "lineage_db":  "<%= @attribute_dict[:lineage_db] %>"
      },
      "additional_attributes": {}
    },
    {
      "in": ["taxid_fasta_out"],
      "out": "taxid_locator_out",
      "class": "PipelineStepGenerateTaxidLocator",
      "module": "idseq_dag.steps.generate_taxid_locator",
      "additional_files": {},
      "additional_attributes": {}
    },
    {
      "in": [
        "gsnap_m8",
        "taxid_locator_out"
      ],
      "out": "alignment_viz_out",
      "class": "PipelineStepGenerateAlignmentViz",
      "module": "idseq_dag.steps.generate_alignment_viz",
      "additional_files": {
        "nt_loc_db": "<%= @attribute_dict[:nt_loc_db] %>"
      },
      "additional_attributes": {
        "nt_db": "<%= @attribute_dict[:nt_db] %>"
      }
    },
    {
      "in": ["fastqs"],
      "out": "srst2_out",
      "class": "PipelineStepRunSRST2",
      "module": "idseq_dag.steps.run_srst2",
      "additional_files": {
        "resist_gene_db": "s3://idseq-database/amr/ARGannot_r2.fasta",
        "resist_genome_bed": "s3://idseq-database/amr/argannot_genome.bed"
      },
      "additional_attributes": {
        "min_cov": 0,
        "n_threads": 16,
        "file_ext": "<%= @attribute_dict[:file_ext] %>"
      }
    },
    {
      "in": ["refined_gsnap_in", "contig_in", "gsnap_m8"],
      "out": "coverage_viz_out",
      "class": "PipelineStepGenerateCoverageViz",
      "module": "idseq_dag.steps.generate_coverage_viz",
      "additional_files": {
        "info_db": "s3://idseq-database/alignment_data/2018-12-01/nt_info.sqlite3"
      },
      "additional_attributes": {}
    },
    {
      "in": ["fastqs", "nonhost_fasta"],
      "out": "nonhost_fastq_out",
      "class": "PipelineStepNonhostFastq",
      "module": "idseq_dag.steps.nonhost_fastq",
      "additional_files": {},
      "additional_attributes": {}
    }
  ],
  "given_targets": {
    "taxid_fasta_in": {
      "s3_dir": "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/results/<%= @attribute_dict[:pipeline_version] %>"
    },
    "gsnap_m8": {
      "s3_dir": "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/results/<%= @attribute_dict[:pipeline_version] %>"
    },
    "refined_gsnap_in": {
      "s3_dir": "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/postprocess/<%= @attribute_dict[:pipeline_version] %>/assembly"
    },
    "contig_in": {
      "s3_dir": "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/postprocess/<%= @attribute_dict[:pipeline_version] %>/assembly"
    },
    "fastqs": {
      "s3_dir": "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/fastqs"
    },
    "nonhost_fasta": {
      "s3_dir": "s3://<%= @attribute_dict[:bucket] %>/samples/<%= @project_id %>/<%= @sample_id %>/postprocess/<%= @attribute_dict[:pipeline_version] %>/assembly"
    }
  }
}
