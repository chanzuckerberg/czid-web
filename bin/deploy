#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'
require 'pp'

def system!(cmd, err = nil)
  system(cmd) || abort("\n== Command #{cmd} failed ==\n\n#{err}\n\n====")
end

env = ARGV.shift
image = ARGV.shift
cluster = env  # Yes, the cluster name is exactly env, no prefix/postfix

if !env || !image
  puts 'Usage: ./bin/deploy ENV IMAGE_TAG'
  abort
end

if image == 'latest'
  puts "you should not deploy latest (it doesn't mean what you think it does)"
  abort
end

puts "deploying #{image} to #{env}"

def notify_slack(env, image, stage)
  slack_hook = ENV["SLACK_HOOK"]
  if slack_hook
    if stage=="start"
      puts `curl -X POST --data-urlencode 'payload={"icon_emoji": ":ghost:", "text": "starting to deploy #{image} to #{env}"}' #{slack_hook}`
    elsif stage=="end"
      puts `curl -X POST --data-urlencode 'payload={"icon_emoji": ":sharkdance:", "text": "finished deploying #{image} to #{env}"}' #{slack_hook}`
    elsif stage=="failure"
      puts `curl -X POST --data-urlencode 'payload={"icon_emoji": ":sob:", "text": "deploy of #{image} to #{env} failed"}' #{slack_hook}`
    end
  else
    puts "Not notifying Slack of this deploy because environment variable SLACK_HOOK is not set. Please add an appropriate webhook to ~/.bash_profile."
  end
end

notify_slack(env, image, "start")
begin
  system!("curl -L https://github.com/chanzuckerberg/czecs/releases/download/v0.1.0-rc1/czecs_0.1.0-rc1_linux_amd64.tar.gz | tar xz -C /tmp czecs")
  task_definition_arn = `/tmp/czecs register --quiet --set tag=#{image} $#{cluster} idseq-#{env}-web czecs.json`
  puts 'running migrations'
  system!("/tmp/czecs task --set taskDefinitionArn=#{task_definition_arn} --set cluster=#{cluster} czecs-task-migrate.json"
  system!("/tmp/czecs update --task-definition-arn #{task_definition_arn} --cluster #{cluster} idseq-#{env}-web czecs.json")
  system!("/tmp/czecs update --set tag=#{image} #{cluster} --set name=resque --set rake_command=resque:workers idseq-#{env}-resque czecs.json")
  system!("/tmp/czecs update --set tag=#{image} #{cluster} --set name=resque-pipeline-monitor --set rake_command=pipeline_monitor idseq-#{env}-resque-pipeline-monitor czecs.json")
  system!("/tmp/czecs update --set tag=#{image} #{cluster} --set name=resque-result-monitor--set rake_command=result_monitor idseq-#{env}-resque-result-monitor czecs.json")
  notify_slack(env, image, "end")
rescue => e
  notify_slack(env, image, "failure")
  raise e
ensure
  system!("rm -f /tmp/czecs")
end
