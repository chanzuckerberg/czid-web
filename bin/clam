#!/bin/bash
#
#  In order for this script to work, you will need PEM credentials for SSH.
#
#  Usage:
#
#      bin/clam alpha bash
#
#      bin/clam alpha 'echo $HOSTNAME'
#
#      bin/clam alpha 'mysqldump -h $RDS_ADDRESS -u $DB_USERNAME --password=$DB_PASSWORD idseq_alpha | gzip -c' > id_alpha.sql.gz
#
#  Above, the specified commands run in the web container on environment "alpha",
#  so that the $HOSTNAME, $RDS_ADDRESS, etc variables are expanded in that
#  environment
#
#  Race conditions during (re)deploy may cause this script to fail or timeout.
#

ENV=$1
shift

MACHINE=`bin/get_public_ip $ENV`

CONTAINER=`ssh ec2-user@$MACHINE "docker ps | grep ecs-idseq-web | head -1" | awk '{print $NF}'`

ssh ec2-user@$MACHINE 'docker exec '$CONTAINER' /bin/bash -c '"'$*'"
