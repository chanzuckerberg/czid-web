#!/bin/bash

export REPO=chanzuckerberg/idseq-web

BRANCH="branch-$1"
COMMIT="sha-$2"
BUILD_NUMBER="build-$3"

echo $BRANCH
echo $COMMIT
echo $REPO
echo $TAG
echo '--'

# Retry up to 5 times total if failed Docker login
status=1
count=1
until [ ${status} -eq 0 ] || [ $count -gt 5 ]; do
    echo "Trying Docker login..."
    docker login -u $DOCKER_USER -p $DOCKER_PASS
    status=$?
    count=$((count+1))
    sleep 15
done

# Retry up to 5 times total if failed Docker push
status=1
count=1
until [ ${status} -eq 0 ] || [ $count -gt 5 ]; do
    echo "Trying Docker push..."
    docker push $REPO
    status=$?
    count=$((count+1))
    sleep 15
done
